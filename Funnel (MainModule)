local FUNNEL_SIZE = 8
local FUNNEL_TAG_NAME = "FUNNEL"

local FUNNEL_DEFAULT_COLOR = Color3.new(0.2, 0.211765, 1)
local FUNNEL_DEFAULT_REVERSE_COLOR = Color3.new(1, 0.356863, 0.0588235)

local collectionService = game:GetService("CollectionService")

local funnelClass = {}
funnelClass.__index = funnelClass

function funnelClass.new(attachment0: Attachment, attachment1: Attachment, speed)
	local self = setmetatable({}, funnelClass)
	
	self.Attachment0 = attachment0
	self.Attachment1 = attachment1
	self.Speed = speed or 5 -- Change 5 to whatever you want to be the funnel speed
	self.Reversed = false
	
	self:_setup()
	
	return self
end

function funnelClass:SetReverse(bool: boolean)
	self.FunnelPart:SetAttribute("Reversed", bool)
end

function funnelClass:SetSpeed(newSpeed: number)
	self.FunnelPart:SetAttribute(newSpeed)
end

function funnelClass:_setup()
	local pAtt0 = self.Attachment0.WorldPosition
	local pAtt1 = self.Attachment1.WorldPosition
	
	local attDistance = (self.Attachment0.WorldPosition - self.Attachment1.WorldPosition).Magnitude
	
	local newFunnelPart = Instance.new("Part")
	newFunnelPart.CanCollide = false
	newFunnelPart.Anchored = true
	newFunnelPart.Color = Color3.new(0.2, 0.211765, 1)
	newFunnelPart.Material = Enum.Material.Neon
	newFunnelPart.Transparency = 1
	newFunnelPart.CastShadow = false
	newFunnelPart.Shape = Enum.PartType.Cylinder
	newFunnelPart.Size = Vector3.new(attDistance, FUNNEL_SIZE, FUNNEL_SIZE) -- Get the distance from attachment0 and attachment1 and set it as the part's size
	newFunnelPart.CFrame = CFrame.lookAt((pAtt0 + pAtt1)/2, pAtt1) * CFrame.Angles(0, math.rad(90), 0) -- Set the part's position to the midpoint between attachment0 and att1 and make it face attachment1
	newFunnelPart.Parent = workspace
	
	newFunnelPart:SetAttribute("StartPoint", self.Attachment0.WorldPosition)
	newFunnelPart:SetAttribute("EndPoint", self.Attachment1.WorldPosition)
	newFunnelPart:SetAttribute("Reversed", self.Reversed)
	newFunnelPart:SetAttribute("Speed", self.Speed)
	
	newFunnelPart:GetAttributeChangedSignal("Speed"):Connect(function()
		self.Speed = newFunnelPart:GetAttribute("Speed")
	end)
	
	newFunnelPart:GetAttributeChangedSignal("Reversed"):Connect(function()
		local isReversed = newFunnelPart:GetAttribute("Reversed")

		self.Reversed = isReversed

		if isReversed then
			self.FunnelPart.Color = FUNNEL_DEFAULT_REVERSE_COLOR
		else
			self.FunnelPart.Color = FUNNEL_DEFAULT_COLOR
		end
	end)
	
	collectionService:AddTag(newFunnelPart, FUNNEL_TAG_NAME)
	
	self.FunnelPart = newFunnelPart
end

function funnelClass:Destroy()
	self.FunnelPart:Destroy()
end


return funnelClass
